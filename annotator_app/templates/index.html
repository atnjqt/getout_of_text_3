{% include 'header.html' %}

<style>
        
        .controls {
            display: flex;
            gap: 15px;
            margin-bottom: 30px;
            align-items: center;
            flex-wrap: wrap;
        }
        
        select, button {
            padding: 10px 20px;
            font-size: 1em;
            border: 1px solid var(--border-secondary);
            border-radius: 8px;
            background: var(--input-bg);
            color: var(--text-primary);
            cursor: pointer;
            transition: all 0.2s;
        }
        
        select {
            min-width: 250px;
        }
        
        button {
            background: #0071e3;
            color: white;
            border: none;
            font-weight: 500;
        }
        
        button:hover {
            background: #0077ed;
            transform: translateY(-1px);
        }
        
        button:disabled {
            background: #d2d2d7;
            cursor: not-allowed;
            transform: none;
        }
        
        .stats {
            display: flex;
            gap: 20px;
            margin-bottom: 30px;
            padding: 15px;
            background: var(--bg-tertiary);
            border-radius: 8px;
            transition: background-color 0.3s ease;
        }
        
        .stat-item {
            flex: 1;
            text-align: center;
        }
        
        .stat-label {
            color: var(--text-secondary);
            font-size: 0.9em;
            margin-bottom: 5px;
        }
        
        .stat-value {
            font-size: 1.8em;
            font-weight: 600;
            color: var(--text-primary);
        }
        
        .kwic-item {
            border: 2px solid var(--border-primary);
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            background: var(--bg-secondary);
            transition: all 0.3s ease;
            display: none;
        }
        
        .kwic-item.active {
            display: block;
        }
        
        .kwic-item.annotated {
            border-color: #34c759;
            background: rgba(52, 199, 89, 0.1);
        }
        
        .navigation-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            background: var(--bg-tertiary);
            border-radius: 8px;
            margin-bottom: 20px;
            transition: background-color 0.3s ease;
        }
        
        .nav-buttons {
            display: flex;
            gap: 10px;
        }
        
        .nav-btn {
            padding: 10px 20px;
            background: #0071e3;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 1em;
            font-weight: 500;
            transition: all 0.2s;
        }
        
        .nav-btn:hover:not(:disabled) {
            background: #0077ed;
            transform: translateY(-1px);
        }
        
        .nav-btn:disabled {
            background: #d2d2d7;
            cursor: not-allowed;
            transform: none;
        }
        
        .nav-btn.skip-btn {
            background: #6e6e73;
        }
        
        .nav-btn.skip-btn:hover:not(:disabled) {
            background: #86868b;
        }
        
        .nav-info {
            font-size: 1.1em;
            font-weight: 600;
            color: var(--text-primary);
        }
        
        .kwic-item {
        
        .kwic-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--border-primary);
        }
        
        .kwic-meta {
            color: var(--text-secondary);
            font-size: 0.9em;
        }
        
        .kwic-context {
            font-size: 1.05em;
            line-height: 1.8;
            margin-bottom: 15px;
            padding: 15px;
            background: var(--bg-tertiary);
            border-radius: 6px;
            color: var(--text-primary);
            transition: all 0.3s ease;
        }
        
        .keyword {
            font-weight: 700;
            color: #0071e3;
            background: var(--keyword-bg);
            padding: 2px 6px;
            border-radius: 4px;
        }
        
        .annotation-form {
            display: grid;
            gap: 15px;
            margin-bottom: 20px;
            padding: 20px;
            background: var(--bg-tertiary);
            border-radius: 8px;
            border: 2px solid #0071e3;
            transition: background-color 0.3s ease;
        }
        
        .form-actions {
            display: flex;
            gap: 10px;
        }
        
        .save-btn {
            flex: 1;
            padding: 12px 30px;
            font-size: 1em;
        }
        
        .skip-annotation-btn {
            padding: 12px 30px;
            background: #ff9500;
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .skip-annotation-btn:hover {
            background: #ffaa33;
            transform: translateY(-1px);
        }
        
        .spacy-section {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 2px solid var(--border-primary);
        }
        
        .form-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        label {
            font-weight: 600;
            color: var(--text-primary);
            font-size: 0.95em;
        }
        
        .radio-group {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }
        
        .radio-option {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 8px 12px;
            border: 2px solid var(--border-primary);
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
            color: var(--text-primary);
        }
        
        .radio-option:hover {
            border-color: #0071e3;
            background: #f5f9ff;
        }
        
        .radio-option input[type="radio"] {
            cursor: pointer;
        }
        
        textarea {
            padding: 12px;
            border: 1px solid var(--border-secondary);
            border-radius: 6px;
            font-family: inherit;
            font-size: 1em;
            resize: vertical;
            min-height: 80px;
            background: var(--input-bg);
            color: var(--text-primary);
            transition: all 0.3s ease;
        }
        
        textarea:focus {
            outline: none;
            border-color: #0071e3;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: var(--text-secondary);
            font-size: 1.1em;
        }
        
        .no-data {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-secondary) !important;
        }
        
        body[data-theme="dark"] .no-data {
            color: var(--text-primary) !important;
        }
        
        .progress-bar {
            width: 100%;
            height: 8px;
            background: var(--border-primary);
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 20px;
            transition: background-color 0.3s ease;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #34c759 0%, #30d158 100%);
            transition: width 0.3s ease;
        }
        
        .success-message {
            padding: 12px 20px;
            background: rgba(52, 199, 89, 0.2);
            color: #34c759;
            border-radius: 6px;
            margin-bottom: 20px;
            animation: slideIn 0.3s ease;
        }
        
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .full-text-toggle {
            margin-top: 10px;
            color: #0071e3;
            cursor: pointer;
            font-size: 0.9em;
            text-decoration: underline;
        }
        
        .full-text {
            display: none;
            margin-top: 10px;
            padding: 15px;
            background: var(--bg-secondary);
            border: 1px solid var(--border-primary);
            border-radius: 6px;
            font-size: 0.95em;
            color: var(--text-primary);
            transition: all 0.3s ease;
        }
        
        .full-text.visible {
            display: block;
        }
        
        .spacy-btn {
            background: #8e44ad;
            color: white;
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9em;
            margin-top: 10px;
            transition: all 0.2s;
        }
        
        .spacy-btn:hover {
            background: #9b59b6;
        }
        
        .spacy-btn:disabled {
            background: #d2d2d7;
            cursor: wait;
        }
        
        .agent-btn {
            background: #0071e3;
            color: white;
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9em;
            margin-top: 10px;
            margin-left: 10px;
            transition: all 0.2s;
        }
        
        .agent-btn:hover {
            background: #0077ed;
        }
        
        .agent-btn:disabled {
            background: #d2d2d7;
            cursor: wait;
        }
        
        .spacy-analysis {
            display: none;
            margin-top: 15px;
            padding: 20px;
            background: var(--bg-tertiary);
            border: 2px solid #8e44ad;
            border-radius: 8px;
            transition: background-color 0.3s ease;
        }
        
        .agent-analysis {
            display: none;
            margin-top: 15px;
            padding: 20px;
            background: var(--bg-tertiary);
            border: 2px solid #0071e3;
            border-radius: 8px;
            transition: background-color 0.3s ease;
        }
        
        .agent-analysis.visible {
            display: block;
            animation: slideIn 0.3s ease;
        }
        
        .agent-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #0071e3;
        }
        
        .agent-header h3 {
            color: #0071e3;
            margin: 0;
        }
        
        .agent-keyword {
            font-size: 0.85em;
            color: var(--text-secondary);
            font-style: italic;
        }
        
        .agent-content {
            font-size: 0.95em;
            line-height: 1.6;
            color: var(--text-primary);
        }
        
        .agent-content h1, .agent-content h2, .agent-content h3 {
            color: #0071e3;
            margin-top: 1em;
            margin-bottom: 0.5em;
        }
        
        .agent-content h1 { font-size: 1.5em; }
        .agent-content h2 { font-size: 1.3em; }
        .agent-content h3 { font-size: 1.1em; }
        
        .agent-content ul, .agent-content ol {
            margin-left: 1.5em;
            margin-bottom: 1em;
        }
        
        .agent-content li {
            margin-bottom: 0.5em;
        }
        
        .agent-content p {
            margin-bottom: 1em;
        }
        
        .agent-content code {
            background: var(--bg-quaternary);
            padding: 2px 6px;
            border-radius: 3px;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
        }
        
        .agent-content pre {
            background: var(--bg-quaternary);
            padding: 12px;
            border-radius: 6px;
            overflow-x: auto;
            margin-bottom: 1em;
        }
        
        .agent-content pre code {
            background: none;
            padding: 0;
        }
        
        .agent-content strong {
            font-weight: 600;
            color: var(--text-primary);
        }
        
        .agent-content em {
            font-style: italic;
        }
        
        .agent-content blockquote {
            border-left: 4px solid #0071e3;
            padding-left: 1em;
            margin-left: 0;
            color: var(--text-secondary);
            font-style: italic;
        }
        
        .spacy-analysis.visible {
            display: block;
            animation: slideIn 0.3s ease;
        }
        
        .spacy-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #8e44ad;
        }
        
        .spacy-header h3 {
            color: #8e44ad;
            margin: 0;
        }
        
        .spacy-model {
            font-size: 0.85em;
            color: var(--text-secondary);
            font-style: italic;
        }
        
        .dep-graph {
            overflow-x: auto;
            margin-bottom: 20px;
            padding: 10px;
            background: var(--bg-secondary);
            border-radius: 6px;
            transition: background-color 0.3s ease;
        }
        
        .tokens-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9em;
            background: var(--bg-secondary);
            border-radius: 6px;
            overflow: hidden;
            transition: background-color 0.3s ease;
        }
        
        .tokens-table th {
            background: #8e44ad;
            color: white;
            padding: 10px;
            text-align: left;
            font-weight: 600;
        }
        
        .tokens-table td {
            padding: 8px 10px;
            border-bottom: 1px solid var(--border-primary);
        }
        
        .tokens-table tr:hover {
            background: var(--hover-bg);
        }
        
        .tokens-filters {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
            padding: 15px;
            background: var(--bg-secondary);
            border-radius: 6px;
            border: 1px solid var(--border-primary);
            transition: all 0.3s ease;
        }
        
        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
            min-width: 150px;
        }
        
        .filter-label {
            font-size: 0.85em;
            font-weight: 600;
            color: var(--text-secondary);
        }
        
        .filter-select {
            padding: 6px 10px;
            border: 1px solid var(--border-secondary);
            border-radius: 4px;
            font-size: 0.9em;
            background: var(--input-bg);
            color: var(--text-primary);
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .filter-input {
            padding: 6px 10px;
            border: 1px solid var(--border-secondary);
            border-radius: 4px;
            font-size: 0.9em;
            width: 200px;
            background: var(--input-bg);
            color: var(--text-primary);
            transition: all 0.3s ease;
        }
        
        .filter-input:focus, .filter-select:focus {
            outline: none;
            border-color: #8e44ad;
        }
        
        .clear-filters-btn {
            padding: 6px 16px;
            background: #6e6e73;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9em;
            align-self: flex-end;
        }
        
        .clear-filters-btn:hover {
            background: #86868b;
        }
        
        .tokens-table tbody tr.hidden {
            display: none;
        }
        
        .filter-count {
            align-self: flex-end;
            padding: 6px 12px;
            background: #e3f2fd;
            color: #1976d2;
            border-radius: 4px;
            font-size: 0.9em;
            font-weight: 600;
        }
        
        .token-tag {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 0.85em;
            font-weight: 600;
        }
        
        .pos-NOUN { background: #e3f2fd; color: #1976d2; }
        .pos-VERB { background: #f3e5f5; color: #7b1fa2; }
        .pos-ADJ { background: #fff3e0; color: #f57c00; }
        .pos-ADV { background: #e8f5e9; color: #388e3c; }
        .pos-PRON { background: #fce4ec; color: #c2185b; }
        .pos-DET { background: #e0f2f1; color: #00796b; }
        .pos-ADP { background: #fff9c4; color: #f57f17; }
        .pos-CONJ, .pos-CCONJ { background: #f3e5f5; color: #8e24aa; }
        .pos-PUNCT { background: #eeeeee; color: #616161; }
        
        .upload-section {
            margin-bottom: 20px;
            padding: 20px;
            background: var(--card-bg);
            border: 2px dashed var(--border-secondary);
            border-radius: 8px;
            text-align: center;
            transition: all 0.3s ease;
        }
        
        .upload-section h3 {
            color: var(--text-primary);
            margin-bottom: 10px;
            font-size: 1.2em;
        }
        
        .upload-section p {
            color: var(--text-secondary);
            margin-bottom: 15px;
            font-size: 0.95em;
        }
        
        .file-input-wrapper {
            position: relative;
            display: inline-block;
        }
        
        .file-input-wrapper input[type="file"] {
            position: absolute;
            left: -9999px;
        }
        
        .file-input-label {
            display: inline-block;
            padding: 10px 20px;
            background: #0071e3;
            color: white;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s;
        }
        
        .file-input-label:hover {
            background: #0077ed;
            transform: translateY(-1px);
        }
        
        .upload-btn {
            padding: 10px 20px;
            background: #34c759;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            margin-left: 10px;
            transition: all 0.2s;
        }
        
        .upload-btn:hover:not(:disabled) {
            background: #30d158;
            transform: translateY(-1px);
        }
        
        .upload-btn:disabled {
            background: #d2d2d7;
            cursor: not-allowed;
            transform: none;
        }
        
        .file-name-display {
            display: inline-block;
            margin-left: 10px;
            color: var(--text-primary);
            font-weight: 500;
        }
        
        .upload-status {
            margin-top: 15px;
            padding: 10px;
            border-radius: 6px;
            display: none;
        }
        
        .upload-status.success {
            display: block;
            background: #d1f4e0;
            color: #0d5c2c;
        }
        
        .upload-status.error {
            display: block;
            background: rgba(255, 59, 48, 0.2);
            color: #ff3b30;
        }
        
        .modal {
            display: none;
            position: fixed;
            z-index: 9999;
            left: 0;
            top: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0, 0, 0, 0.5);
        }
        
        .modal.show {
            display: flex !important;
            align-items: center;
            justify-content: center;
            animation: fadeIn 0.2s;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        .modal-content {
            background: var(--bg-secondary);
            border-radius: 12px;
            padding: 30px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.2);
            animation: slideUp 0.3s;
            position: relative;
            z-index: 10000;
            transition: background-color 0.3s ease;
        }
        
        @keyframes slideUp {
            from {
                transform: translateY(20px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .modal-header h3 {
            color: var(--text-primary);
            font-size: 1.5em;
            margin: 0;
        }
        
        .modal-content p {
            color: var(--text-secondary);
            margin-bottom: 20px;
            line-height: 1.5;
        }
        
        .modal-content .file-input-wrapper {
            margin-bottom: 15px;
        }
        
        .modal-content .file-name-display {
            display: block;
            margin: 10px 0;
            min-height: 20px;
        }
        
        .modal-content .upload-btn {
            width: 100%;
            margin: 10px 0 0 0;
        }
        
        .modal-content .upload-status {
            margin-top: 15px;
        }
        
        .close-modal {
            background: none;
            border: none;
            font-size: 1.5em;
            color: var(--text-secondary);
            cursor: pointer;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: all 0.2s;
        }
        
        .close-modal:hover {
            background: var(--hover-bg);
            color: var(--text-primary);
            transform: none;
        }
        
        .upload-btn-primary {
            background: #ff9500 !important;
        }
        
        .upload-btn-primary:hover {
            background: #ff9f0a !important;
        }
        
        .upload-btn-primary:disabled {
            background: #d2d2d7 !important;
            cursor: not-allowed;
        }
        
        .container {
            max-width: 1200px;
        }
    </style>

        <div class="controls">
            <select id="fileSelect">
                <option value="">Select a KWIC file...</option>
                {% for file in files %}
                <option value="{{ file }}">{{ file }}</option>
                {% endfor %}
            </select>
            <button id="loadBtn" disabled>Load File</button>
            <button id="openUploadModal" class="upload-btn-primary">üì§ Upload CSV</button>
            <button id="exportBtn" disabled>Export Annotations</button>
        </div>
        
        <div class="controls">
            <div style="display: flex; align-items: center; gap: 10px;">
                <input type="checkbox" id="randomSampleToggle">
                <label for="randomSampleToggle" style="margin: 0;">Random Sample</label>
                <input type="number" id="sampleSize" value="50" min="1" max="1000" step="10" disabled style="width: 80px;">
                <button id="applySampleBtn" disabled style="background: #ff9500;">Apply Sample</button>
                <button id="resetSampleBtn" disabled style="background: #ff3b30; display: none;">Reset to Full Dataset</button>
            </div>
            <div style="display: flex; align-items: center; gap: 10px; margin-left: 20px; padding-left: 20px; border-left: 2px solid var(--border-secondary);">
                <input type="checkbox" id="showAnnotatedOnlyToggle">
                <label for="showAnnotatedOnlyToggle" style="margin: 0;">Show Annotated Only</label>
            </div>
        </div>
        
        <div id="statsContainer" style="display: none;">
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill" style="width: 0%;"></div>
            </div>
            <div class="stats">
                <div class="stat-item">
                    <div class="stat-label">Total Items</div>
                    <div class="stat-value" id="totalStat">0</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">Annotated</div>
                    <div class="stat-value" id="annotatedStat">0</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">Remaining</div>
                    <div class="stat-value" id="remainingStat">0</div>
                </div>
            </div>
        </div>
        
        <div id="navigationControls" style="display: none;">
            <div class="navigation-controls">
                <div class="nav-buttons">
                    <button class="nav-btn" id="prevBtn" onclick="navigateKwic(-1)">‚Üê Previous</button>
                    <button class="nav-btn skip-btn" id="skipBtn" onclick="skipKwic()">Skip</button>
                    <button class="nav-btn" id="nextBtn" onclick="navigateKwic(1)">Next ‚Üí</button>
                </div>
                <div class="nav-info" id="navInfo">Item 1 of 0</div>
            </div>
        </div>
        
        <div id="content">
            <div class="no-data">
                üëÜ Select a file from the dropdown to begin annotation
            </div>
        </div>
    </div>
    
    <!-- Marked.js for markdown rendering -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    
    <!-- Upload Modal -->
    <div id="uploadModal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3>üì§ Upload Sketch Engine CSV</h3>
                <button class="close-modal" id="closeModal">&times;</button>
            </div>
            <p>Upload a concordance CSV file exported from Sketch Engine. The file will be converted to KWIC format.</p>
            <div class="file-input-wrapper">
                <input type="file" id="csvFileInput" accept=".csv" />
                <label for="csvFileInput" class="file-input-label">Choose CSV File</label>
            </div>
            <span class="file-name-display" id="fileNameDisplay"></span>
            <button class="upload-btn" id="uploadBtn" disabled>Upload & Convert</button>
            <div class="upload-status" id="uploadStatus"></div>
        </div>
    </div>
    
    <script>
        // Debug: Check if modal exists on page load
        document.addEventListener('DOMContentLoaded', function() {
            const modal = document.getElementById('uploadModal');
            console.log('Modal found:', modal);
            console.log('Modal display style:', window.getComputedStyle(modal).display);
        });
    </script>
    
    <script>
        let currentFile = null;
        let kwicData = null;
        let annotations = {};
        let allItems = [];  // Flattened array of all KWIC items with metadata
        let allItemsBackup = [];  // Backup of full dataset before sampling
        let currentIndex = 0;  // Current position in allItems array
        let isSampled = false;  // Track if currently showing a sample
        
        const fileSelect = document.getElementById('fileSelect');
        const loadBtn = document.getElementById('loadBtn');
        const exportBtn = document.getElementById('exportBtn');
        const content = document.getElementById('content');
        const statsContainer = document.getElementById('statsContainer');
        
        // Modal controls
        const uploadModal = document.getElementById('uploadModal');
        const openUploadModalBtn = document.getElementById('openUploadModal');
        const closeModalBtn = document.getElementById('closeModal');
        
        if (openUploadModalBtn) {
            openUploadModalBtn.addEventListener('click', function(e) {
                e.preventDefault();
                console.log('Opening modal - button clicked');
                console.log('Modal element:', uploadModal);
                uploadModal.style.display = 'flex';
                uploadModal.classList.add('show');
            });
        } else {
            console.error('Upload modal button not found!');
        }
        
        if (closeModalBtn) {
            closeModalBtn.addEventListener('click', function() {
                console.log('Closing modal');
                uploadModal.style.display = 'none';
                uploadModal.classList.remove('show');
            });
        }
        
        // Close modal when clicking outside
        if (uploadModal) {
            uploadModal.addEventListener('click', function(e) {
                if (e.target === uploadModal) {
                    uploadModal.style.display = 'none';
                    uploadModal.classList.remove('show');
                }
            });
        }
        
        // Close modal on Escape key
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape' && uploadModal && uploadModal.style.display === 'flex') {
                uploadModal.style.display = 'none';
                uploadModal.classList.remove('show');
            }
        });
        
        // Random sample controls
        const randomSampleToggle = document.getElementById('randomSampleToggle');
        const sampleSizeInput = document.getElementById('sampleSize');
        const applySampleBtn = document.getElementById('applySampleBtn');
        const resetSampleBtn = document.getElementById('resetSampleBtn');
        
        // Show annotated only toggle
        const showAnnotatedOnlyToggle = document.getElementById('showAnnotatedOnlyToggle');
        let filteredItems = [];  // Filtered view of items
        let isFiltered = false;  // Track if filter is active
        
        randomSampleToggle.addEventListener('change', function() {
            sampleSizeInput.disabled = !this.checked;
            applySampleBtn.disabled = !this.checked || allItems.length === 0;
        });
        
        showAnnotatedOnlyToggle.addEventListener('change', function() {
            applyAnnotatedFilter();
        });
        
        applySampleBtn.addEventListener('click', function() {
            applyRandomSample();
        });
        
        resetSampleBtn.addEventListener('click', function() {
            resetToFullDataset();
        });
        
        function applyRandomSample() {
            const sampleSize = parseInt(sampleSizeInput.value);
            
            if (sampleSize <= 0 || sampleSize > allItems.length) {
                alert(`Sample size must be between 1 and ${allItems.length}`);
                return;
            }
            
            // Backup full dataset if not already backed up
            if (!isSampled) {
                allItemsBackup = [...allItems];
            }
            
            // Create random sample
            const indices = Array.from({length: allItems.length}, (_, i) => i);
            const shuffled = indices.sort(() => Math.random() - 0.5);
            const sampleIndices = shuffled.slice(0, sampleSize);
            
            allItems = sampleIndices.map(i => allItemsBackup[i]);
            isSampled = true;
            
            // Reset to first item
            currentIndex = 0;
            renderCurrentKwicItem();
            
            // Update UI
            resetSampleBtn.style.display = 'inline-block';
            applySampleBtn.textContent = 'Re-sample';
            
            // Update stats to reflect sample
            updateStatsForSample();
        }
        
        function resetToFullDataset() {
            if (!isSampled) return;
            
            allItems = [...allItemsBackup];
            isSampled = false;
            
            currentIndex = 0;
            renderCurrentKwicItem();
            
            // Update UI
            resetSampleBtn.style.display = 'none';
            applySampleBtn.textContent = 'Apply Sample';
            
            // Restore full stats
            updateNavigation();
        }
        
        function updateStatsForSample() {
            // Count annotations in current sample
            let annotatedInSample = 0;
            for (const item of allItems) {
                const annotation = annotations[item.genreKey]?.[item.index];
                if (annotation) {
                    annotatedInSample++;
                }
            }
            
            const sampleTotal = allItems.length;
            const sampleRemaining = sampleTotal - annotatedInSample;
            
            document.getElementById('totalStat').textContent = `${sampleTotal} (sample)`;
            document.getElementById('annotatedStat').textContent = annotatedInSample;
            document.getElementById('remainingStat').textContent = sampleRemaining;
            
            const progress = sampleTotal > 0 ? (annotatedInSample / sampleTotal * 100) : 0;
            document.getElementById('progressFill').style.width = `${progress}%`;
        }
        
        function applyAnnotatedFilter() {
            const showAnnotatedOnly = showAnnotatedOnlyToggle.checked;
            
            if (showAnnotatedOnly) {
                // Filter to show only annotated items
                const sourceItems = isSampled ? allItemsBackup : allItems;
                filteredItems = sourceItems.filter(item => {
                    const annotation = annotations[item.genreKey]?.[item.index];
                    return annotation && annotation.classification;
                });
                
                if (filteredItems.length === 0) {
                    alert('No annotated items found in the dataset.');
                    showAnnotatedOnlyToggle.checked = false;
                    return;
                }
                
                // Backup current items if not already filtered
                if (!isFiltered && !isSampled) {
                    allItemsBackup = [...allItems];
                }
                
                allItems = [...filteredItems];
                isFiltered = true;
                
                // Reset to first item
                currentIndex = 0;
                renderCurrentKwicItem();
                
                // Update stats
                updateAnnotatedFilterStats();
            } else {
                // Restore original view
                if (isFiltered) {
                    if (isSampled) {
                        // Restore sample
                        allItems = [...filteredItems];
                    } else {
                        // Restore full dataset
                        allItems = [...allItemsBackup];
                    }
                    isFiltered = false;
                    
                    currentIndex = 0;
                    renderCurrentKwicItem();
                    updateNavigation();
                }
            }
        }
        
        function updateAnnotatedFilterStats() {
            const filteredTotal = allItems.length;
            
            document.getElementById('totalStat').textContent = `${filteredTotal} (annotated)`;
            document.getElementById('annotatedStat').textContent = filteredTotal;
            document.getElementById('remainingStat').textContent = 0;
            
            document.getElementById('progressFill').style.width = '100%';
        }
        
        // Upload functionality
        const csvFileInput = document.getElementById('csvFileInput');
        const fileNameDisplay = document.getElementById('fileNameDisplay');
        const uploadBtn = document.getElementById('uploadBtn');
        const uploadStatus = document.getElementById('uploadStatus');
        
        csvFileInput.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                fileNameDisplay.textContent = file.name;
                uploadBtn.disabled = false;
            } else {
                fileNameDisplay.textContent = '';
                uploadBtn.disabled = true;
            }
            uploadStatus.style.display = 'none';
        });
        
        uploadBtn.addEventListener('click', async function() {
            const file = csvFileInput.files[0];
            if (!file) return;
            
            uploadBtn.disabled = true;
            uploadStatus.style.display = 'none';
            
            const formData = new FormData();
            formData.append('file', file);
            
            try {
                const response = await fetch('/api/upload_csv', {
                    method: 'POST',
                    body: formData
                });
                
                const result = await response.json();
                
                if (result.success) {
                    uploadStatus.className = 'upload-status success';
                    uploadStatus.textContent = `‚úÖ ${result.message} (${result.total_items} concordance lines converted)`;
                    uploadStatus.style.display = 'block';
                    
                    // Add new file to dropdown
                    const option = document.createElement('option');
                    option.value = result.filename;
                    option.textContent = result.filename;
                    fileSelect.appendChild(option);
                    fileSelect.value = result.filename;
                    loadBtn.disabled = false;
                    
                    // Reset upload form
                    csvFileInput.value = '';
                    fileNameDisplay.textContent = '';
                    uploadBtn.disabled = true;
                    
                    // Close modal after a brief delay
                    setTimeout(() => {
                        uploadModal.style.display = 'none';
                        uploadModal.classList.remove('show');
                        uploadStatus.style.display = 'none';
                    }, 2000);
                } else {
                    uploadStatus.className = 'upload-status error';
                    uploadStatus.textContent = `‚ùå Error: ${result.error}`;
                    uploadStatus.style.display = 'block';
                    uploadBtn.disabled = false;
                }
            } catch (error) {
                uploadStatus.className = 'upload-status error';
                uploadStatus.textContent = `‚ùå Upload failed: ${error.message}`;
                uploadStatus.style.display = 'block';
                uploadBtn.disabled = false;
            }
        });
        
        fileSelect.addEventListener('change', () => {
            loadBtn.disabled = !fileSelect.value;
        });
        
        loadBtn.addEventListener('click', loadFile);
        exportBtn.addEventListener('click', exportAnnotations);
        
        async function loadFile() {
            const filename = fileSelect.value;
            if (!filename) return;
            
            content.innerHTML = '<div class="loading">‚è≥ Loading data...</div>';
            currentFile = filename;
            
            try {
                const response = await fetch(`/api/load/${filename}`);
                const result = await response.json();
                
                if (result.error) {
                    content.innerHTML = `<div class="no-data">‚ùå Error: ${result.error}</div>`;
                    return;
                }
                
                kwicData = result.data;
                annotations = result.annotations;
                updateStats(result.stats);
                
                // Flatten KWIC data into single array with metadata
                allItems = [];
                for (const [genreKey, items] of Object.entries(kwicData)) {
                    items.forEach((item, index) => {
                        allItems.push({
                            genreKey: genreKey,
                            index: index,
                            item: item
                        });
                    });
                }
                
                currentIndex = 0;
                renderCurrentKwicItem();
                
                exportBtn.disabled = false;
                statsContainer.style.display = 'block';
                document.getElementById('navigationControls').style.display = 'block';
                
                // Enable random sample controls
                if (randomSampleToggle.checked) {
                    applySampleBtn.disabled = false;
                }
                
                // Reset sample state
                isSampled = false;
                allItemsBackup = [];
                resetSampleBtn.style.display = 'none';
                applySampleBtn.textContent = 'Apply Sample';
                
            } catch (error) {
                content.innerHTML = `<div class="no-data">‚ùå Error loading file: ${error.message}</div>`;
            }
        }
        
        function updateStats(stats) {
            if (isSampled) {
                updateStatsForSample();
            } else {
                document.getElementById('totalStat').textContent = stats.total;
                document.getElementById('annotatedStat').textContent = stats.annotated;
                document.getElementById('remainingStat').textContent = stats.remaining;
                
                const progress = stats.total > 0 ? (stats.annotated / stats.total * 100) : 0;
                document.getElementById('progressFill').style.width = `${progress}%`;
            }
        }
        
        function renderCurrentKwicItem() {
            if (allItems.length === 0) {
                content.innerHTML = '<div class="no-data">No KWIC items found</div>';
                return;
            }
            
            const currentItem = allItems[currentIndex];
            content.innerHTML = '';
            
            const kwicItem = createKwicItem(currentItem.genreKey, currentItem.index, currentItem.item);
            kwicItem.classList.add('active');
            content.appendChild(kwicItem);
            
            updateNavigation();
        }
        
        function updateNavigation() {
            const prevBtn = document.getElementById('prevBtn');
            const nextBtn = document.getElementById('nextBtn');
            const navInfo = document.getElementById('navInfo');
            
            prevBtn.disabled = currentIndex === 0;
            nextBtn.disabled = currentIndex === allItems.length - 1;
            
            navInfo.textContent = `Item ${currentIndex + 1} of ${allItems.length}`;
        }
        
        function navigateKwic(direction) {
            const newIndex = currentIndex + direction;
            if (newIndex >= 0 && newIndex < allItems.length) {
                currentIndex = newIndex;
                renderCurrentKwicItem();
                window.scrollTo({ top: 0, behavior: 'smooth' });
            }
        }
        
        function skipKwic() {
            navigateKwic(1);
        }
        
        function renderKwicItems() {
            content.innerHTML = '';
            
            for (const [genreKey, items] of Object.entries(kwicData)) {
                items.forEach((item, index) => {
                    const kwicItem = createKwicItem(genreKey, index, item);
                    content.appendChild(kwicItem);
                });
            }
        }
        
        function createKwicItem(genreKey, index, item) {
            const div = document.createElement('div');
            div.className = 'kwic-item';
            
            const existingAnnotation = annotations[genreKey]?.[index];
            if (existingAnnotation) {
                div.classList.add('annotated');
            }
            
            // Highlight the keyword in context
            const highlightedContext = item.context.replace(
                /\*\*(.*?)\*\*/g, 
                '<span class="keyword">$1</span>'
            );
            
            div.innerHTML = `
                <div class="kwic-header">
                    <div class="kwic-meta">
                        <strong>${genreKey}</strong> ‚Ä¢ Item ${index + 1} ‚Ä¢ Text ID: ${item.text_id}
                    </div>
                    ${existingAnnotation ? '<span style="color: #34c759; font-weight: 600;">‚úì Annotated</span>' : ''}
                </div>
                
                <div class="kwic-context">${highlightedContext}</div>
                
                <div class="full-text-toggle" onclick="toggleFullText(this)">
                    Show full text ‚ñº
                </div>
                <div class="full-text">${item.full_text}</div>
                
                <form class="annotation-form" onsubmit="saveAnnotation(event, '${genreKey}', ${index})">
                    <div class="form-group">
                        <label>Classification:</label>
                        <div class="radio-group">
                            <label class="radio-option">
                                <input type="radio" name="classification_${genreKey}_${index}" value="literal" 
                                    ${existingAnnotation?.classification === 'literal' ? 'checked' : ''} required>
                                Literal
                            </label>
                            <label class="radio-option">
                                <input type="radio" name="classification_${genreKey}_${index}" value="figurative"
                                    ${existingAnnotation?.classification === 'figurative' ? 'checked' : ''} required>
                                Figurative
                            </label>
                            <label class="radio-option">
                                <input type="radio" name="classification_${genreKey}_${index}" value="neither"
                                    ${existingAnnotation?.classification === 'neither' ? 'checked' : ''} required>
                                Neither
                            </label>
                            <label class="radio-option">
                                <input type="radio" name="classification_${genreKey}_${index}" value="unclear"
                                    ${existingAnnotation?.classification === 'unclear' ? 'checked' : ''} required>
                                Unclear
                            </label>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label>Notes (optional):</label>
                        <textarea name="notes" placeholder="Add any observations or reasoning...">${existingAnnotation?.notes || ''}</textarea>
                    </div>
                    
                    <div class="form-actions">
                        <button type="submit" class="save-btn nav-btn">üíæ Save & Next</button>
                        <button type="button" class="skip-annotation-btn" onclick="skipKwic()">Skip ‚Üí</button>
                    </div>
                </form>
                
                <div class="spacy-section">
                    <button class="spacy-btn" onclick="loadSpacyAnalysis(this, '${genreKey}', ${index})">
                        üî¨ Load spaCy Morphology
                    </button>
                    
                    <div style="display: inline-block; margin-left: 10px;">
                        <input type="text" 
                               id="keyword_input_${genreKey}_${index}" 
                               class="keyword-input" 
                               placeholder="Override keyword (optional)"
                               style="padding: 8px 12px; border: 1px solid #d2d2d7; border-radius: 6px; font-size: 0.9em; width: 200px;">
                    </div>
                    
                    <button class="agent-btn" onclick="loadAgentAnalysis(this, '${genreKey}', ${index})">
                        ü§ñ AI Agent: Analyze Keyword
                    </button>
                    
                    <div class="spacy-analysis" id="spacy_${genreKey}_${index}">
                        <div class="spacy-header">
                            <h3>Morphological Analysis</h3>
                            <span class="spacy-model"></span>
                        </div>
                        <div class="dep-graph"></div>
                        <h4 style="margin-bottom: 10px;">Token Details:</h4>
                        <div class="tokens-container"></div>
                    </div>
                    
                    <div class="agent-analysis" id="agent_${genreKey}_${index}">
                        <div class="agent-header">
                            <h3>ü§ñ AI Agent Analysis</h3>
                            <div style="display: flex; gap: 15px; align-items: center;">
                                <span class="agent-keyword"></span>
                                <span class="agent-timer" style="font-size: 0.85em; color: #6e6e73; font-style: italic;"></span>
                            </div>
                        </div>
                        <div class="agent-content"></div>
                    </div>
                </div>
            `;
            
            return div;
        }
        
        function toggleFullText(element) {
            const fullText = element.nextElementSibling;
            fullText.classList.toggle('visible');
            element.textContent = fullText.classList.contains('visible') 
                ? 'Hide full text ‚ñ≤' 
                : 'Show full text ‚ñº';
        }
        
        async function loadSpacyAnalysis(button, genreKey, index) {
            const analysisDiv = document.getElementById(`spacy_${genreKey}_${index}`);
            
            // Toggle if already loaded
            if (analysisDiv.classList.contains('visible')) {
                analysisDiv.classList.remove('visible');
                button.textContent = 'üî¨ Load spaCy Morphology';
                return;
            }
            
            // Disable button while loading
            button.disabled = true;
            button.textContent = '‚è≥ Loading...';
            
            // Get the context text from this KWIC item
            const kwicItem = button.closest('.kwic-item');
            const contextDiv = kwicItem.querySelector('.kwic-context');
            const contextText = contextDiv.textContent;
            
            try {
                const response = await fetch('/api/spacy_analysis', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        context: contextText
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    // Update model name
                    analysisDiv.querySelector('.spacy-model').textContent = `Model: ${result.model}`;
                    
                    // Insert dependency graph
                    analysisDiv.querySelector('.dep-graph').innerHTML = result.dep_svg;
                    
                    // Create tokens table with filters
                    const tokensHTML = createTokensTableWithFilters(result.tokens, genreKey, index);
                    analysisDiv.querySelector('.tokens-container').innerHTML = tokensHTML;
                    
                    // Initialize filter event listeners
                    initializeTokenFilters(genreKey, index, result.tokens);
                    
                    // Show analysis
                    analysisDiv.classList.add('visible');
                    button.textContent = 'üî¨ Hide spaCy Morphology';
                } else {
                    alert('Error loading spaCy analysis: ' + result.error);
                    button.textContent = 'üî¨ Load spaCy Morphology';
                }
                
            } catch (error) {
                alert('Error loading spaCy analysis: ' + error.message);
                button.textContent = 'üî¨ Load spaCy Morphology';
            } finally {
                button.disabled = false;
            }
        }
        
        async function loadAgentAnalysis(button, genreKey, index) {
            const analysisDiv = document.getElementById(`agent_${genreKey}_${index}`);
            
            // Toggle if already loaded
            if (analysisDiv.classList.contains('visible')) {
                analysisDiv.classList.remove('visible');
                button.textContent = 'ü§ñ AI Agent: Analyze Keyword';
                return;
            }
            
            // Disable button while loading
            button.disabled = true;
            
            // Start timer
            const startTime = Date.now();
            const timerSpan = analysisDiv.querySelector('.agent-timer');
            
            // Initialize timer display
            timerSpan.textContent = '‚è±Ô∏è 0.0s';
            timerSpan.style.display = 'inline';
            
            // Update button with timer
            button.textContent = '‚è≥ Agent Working...';
            
            // Update timer every 100ms
            const timerInterval = setInterval(() => {
                const elapsed = ((Date.now() - startTime) / 1000).toFixed(1);
                timerSpan.textContent = `‚è±Ô∏è ${elapsed}s`;
                button.textContent = `‚è≥ Agent Working... (${elapsed}s)`;
            }, 100);
            
            // Get the context text and keyword from this KWIC item
            const kwicItem = button.closest('.kwic-item');
            const contextDiv = kwicItem.querySelector('.kwic-context');
            const contextText = contextDiv.textContent;
            
            // Check if there's a custom keyword input
            const keywordInput = document.getElementById(`keyword_input_${genreKey}_${index}`);
            let keyword = '';
            
            if (keywordInput && keywordInput.value.trim()) {
                // Use custom keyword if provided
                keyword = keywordInput.value.trim();
            } else {
                // Extract keyword from the bold text
                const keywordMatch = contextDiv.innerHTML.match(/<span class="keyword">(.*?)<\/span>/);
                keyword = keywordMatch ? keywordMatch[1] : '';
            }
            
            try {
                const response = await fetch('/api/agent_analysis', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        context: contextText,
                        keyword: keyword
                    })
                });
                
                const result = await response.json();
                
                // Stop timer
                clearInterval(timerInterval);
                const totalTime = ((Date.now() - startTime) / 1000).toFixed(1);
                
                if (result.success) {
                    // Update keyword display
                    analysisDiv.querySelector('.agent-keyword').textContent = 
                        keyword ? `Keyword: "${keyword}"` : 'General Analysis';
                    
                    // Show final time
                    timerSpan.textContent = `‚è±Ô∏è ${totalTime}s`;
                    
                    // Render markdown as HTML using marked.js
                    const contentDiv = analysisDiv.querySelector('.agent-content');
                    if (typeof marked !== 'undefined') {
                        // Configure marked for better rendering
                        marked.setOptions({
                            breaks: true,  // Convert line breaks to <br>
                            gfm: true      // GitHub Flavored Markdown
                        });
                        contentDiv.innerHTML = marked.parse(result.analysis);
                    } else {
                        // Fallback if marked.js didn't load
                        contentDiv.textContent = result.analysis;
                    }
                    
                    // Show analysis
                    analysisDiv.classList.add('visible');
                    button.textContent = 'ü§ñ Hide Agent Analysis';
                } else {
                    timerSpan.textContent = '';
                    alert('Error loading agent analysis: ' + result.error);
                    button.textContent = 'ü§ñ AI Agent: Analyze Keyword';
                }
                
            } catch (error) {
                clearInterval(timerInterval);
                timerSpan.textContent = '';
                alert('Error loading agent analysis: ' + error.message);
                button.textContent = 'ü§ñ AI Agent: Analyze Keyword';
            } finally {
                button.disabled = false;
            }
        }
        
        function createTokensTableWithFilters(tokens, genreKey, index) {
            const uniquePOS = [...new Set(tokens.map(t => t.pos))].sort();
            const uniqueTags = [...new Set(tokens.map(t => t.tag))].sort();
            const uniqueDeps = [...new Set(tokens.map(t => t.dep))].sort();
            
            let html = `
                <div class="tokens-filters" id="filters_${genreKey}_${index}">
                    <div class="filter-group">
                        <label class="filter-label">Search Token/Lemma:</label>
                        <input type="text" class="filter-input" id="search_${genreKey}_${index}" 
                               placeholder="Type to search...">
                    </div>
                    
                    <div class="filter-group">
                        <label class="filter-label">POS:</label>
                        <select class="filter-select" id="pos_filter_${genreKey}_${index}">
                            <option value="">All</option>
                            ${uniquePOS.map(pos => `<option value="${pos}">${pos}</option>`).join('')}
                        </select>
                    </div>
                    
                    <div class="filter-group">
                        <label class="filter-label">Tag:</label>
                        <select class="filter-select" id="tag_filter_${genreKey}_${index}">
                            <option value="">All</option>
                            ${uniqueTags.map(tag => `<option value="${tag}">${tag}</option>`).join('')}
                        </select>
                    </div>
                    
                    <div class="filter-group">
                        <label class="filter-label">Dependency:</label>
                        <select class="filter-select" id="dep_filter_${genreKey}_${index}">
                            <option value="">All</option>
                            ${uniqueDeps.map(dep => `<option value="${dep}">${dep}</option>`).join('')}
                        </select>
                    </div>
                    
                    <button class="clear-filters-btn" onclick="clearTokenFilters('${genreKey}', ${index})">
                        Clear Filters
                    </button>
                    
                    <div class="filter-count" id="count_${genreKey}_${index}">
                        Showing ${tokens.length} of ${tokens.length}
                    </div>
                </div>
            `;
            
            html += createTokensTable(tokens, genreKey, index);
            
            return html;
        }
        
        function createTokensTable(tokens, genreKey, index) {
            const tableId = genreKey && index !== undefined ? `table_${genreKey}_${index}` : '';
            
            let html = `
                <table class="tokens-table" id="${tableId}">
                    <thead>
                        <tr>
                            <th>Token</th>
                            <th>Lemma</th>
                            <th>POS</th>
                            <th>Tag</th>
                            <th>Dependency</th>
                            <th>Head</th>
                            <th>Children</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            tokens.forEach((token, idx) => {
                html += `
                    <tr data-token="${token.text.toLowerCase()}" 
                        data-lemma="${token.lemma.toLowerCase()}"
                        data-pos="${token.pos}" 
                        data-tag="${token.tag}" 
                        data-dep="${token.dep}">
                        <td><strong>${token.text}</strong></td>
                        <td>${token.lemma}</td>
                        <td><span class="token-tag pos-${token.pos}">${token.pos}</span></td>
                        <td><span class="token-tag">${token.tag}</span></td>
                        <td><span class="token-tag">${token.dep}</span></td>
                        <td>${token.head} <small>(${token.head_pos})</small></td>
                        <td>${token.children.join(', ') || '‚Äî'}</td>
                    </tr>
                `;
            });
            
            html += `
                    </tbody>
                </table>
            `;
            
            return html;
        }
        
        function initializeTokenFilters(genreKey, index, tokens) {
            const searchInput = document.getElementById(`search_${genreKey}_${index}`);
            const posFilter = document.getElementById(`pos_filter_${genreKey}_${index}`);
            const tagFilter = document.getElementById(`tag_filter_${genreKey}_${index}`);
            const depFilter = document.getElementById(`dep_filter_${genreKey}_${index}`);
            
            const applyFilters = () => {
                const searchTerm = searchInput.value.toLowerCase();
                const posValue = posFilter.value;
                const tagValue = tagFilter.value;
                const depValue = depFilter.value;
                
                const table = document.getElementById(`table_${genreKey}_${index}`);
                const rows = table.querySelectorAll('tbody tr');
                let visibleCount = 0;
                
                rows.forEach(row => {
                    const token = row.dataset.token;
                    const lemma = row.dataset.lemma;
                    const pos = row.dataset.pos;
                    const tag = row.dataset.tag;
                    const dep = row.dataset.dep;
                    
                    const matchesSearch = !searchTerm || token.includes(searchTerm) || lemma.includes(searchTerm);
                    const matchesPOS = !posValue || pos === posValue;
                    const matchesTag = !tagValue || tag === tagValue;
                    const matchesDep = !depValue || dep === depValue;
                    
                    if (matchesSearch && matchesPOS && matchesTag && matchesDep) {
                        row.classList.remove('hidden');
                        visibleCount++;
                    } else {
                        row.classList.add('hidden');
                    }
                });
                
                // Update count
                document.getElementById(`count_${genreKey}_${index}`).textContent = 
                    `Showing ${visibleCount} of ${tokens.length}`;
            };
            
            searchInput.addEventListener('input', applyFilters);
            posFilter.addEventListener('change', applyFilters);
            tagFilter.addEventListener('change', applyFilters);
            depFilter.addEventListener('change', applyFilters);
        }
        
        function clearTokenFilters(genreKey, index) {
            document.getElementById(`search_${genreKey}_${index}`).value = '';
            document.getElementById(`pos_filter_${genreKey}_${index}`).value = '';
            document.getElementById(`tag_filter_${genreKey}_${index}`).value = '';
            document.getElementById(`dep_filter_${genreKey}_${index}`).value = '';
            
            // Trigger filter update
            document.getElementById(`search_${genreKey}_${index}`).dispatchEvent(new Event('input'));
        }
        
        async function saveAnnotation(event, genreKey, index) {
            event.preventDefault();
            
            const form = event.target;
            const formData = new FormData(form);
            const classification = formData.get(`classification_${genreKey}_${index}`);
            const notes = formData.get('notes');
            
            try {
                const response = await fetch('/api/save', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        filename: currentFile,
                        genre_key: genreKey,
                        index: index,
                        annotation: {
                            classification: classification,
                            notes: notes
                        }
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    // Update local annotations
                    if (!annotations[genreKey]) {
                        annotations[genreKey] = {};
                    }
                    annotations[genreKey][index] = {
                        classification: classification,
                        notes: notes
                    };
                    
                    // Update UI
                    form.closest('.kwic-item').classList.add('annotated');
                    
                    // Show success message
                    showSuccessMessage('Annotation saved successfully!');
                    
                    // Update stats
                    const total = Object.values(kwicData).reduce((sum, items) => sum + items.length, 0);
                    const annotated = Object.values(annotations).reduce((sum, genre) => sum + Object.keys(genre).length, 0);
                    updateStats({
                        total: total,
                        annotated: annotated,
                        remaining: total - annotated
                    });
                    
                    // Auto-advance to next item
                    setTimeout(() => {
                        navigateKwic(1);
                    }, 500);
                } else {
                    alert('Error saving annotation: ' + result.error);
                }
                
            } catch (error) {
                alert('Error saving annotation: ' + error.message);
            }
        }
        
        function showSuccessMessage(message) {
            const existing = document.querySelector('.success-message');
            if (existing) existing.remove();
            
            const msg = document.createElement('div');
            msg.className = 'success-message';
            msg.textContent = message;
            content.insertBefore(msg, content.firstChild);
            
            setTimeout(() => msg.remove(), 3000);
        }
        
        async function exportAnnotations() {
            if (!currentFile) return;
            
            try {
                const response = await fetch(`/api/export/${currentFile}`);
                const result = await response.json();
                
                const dataStr = JSON.stringify(result, null, 2);
                const dataBlob = new Blob([dataStr], { type: 'application/json' });
                const url = URL.createObjectURL(dataBlob);
                
                const link = document.createElement('a');
                link.href = url;
                link.download = `${currentFile.replace('.json', '')}_annotations_export.json`;
                link.click();
                
                URL.revokeObjectURL(url);
                showSuccessMessage('Annotations exported successfully!');
                
            } catch (error) {
                alert('Error exporting annotations: ' + error.message);
            }
        }
    </script>

{% include 'footer.html' %}
