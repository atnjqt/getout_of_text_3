<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Settings</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="/static/css/style.css">
    <style>
        /* Dark mode styles for Bootstrap components */
        body[data-theme="dark"] .card {
            background-color: var(--bg-secondary);
            border-color: var(--border-primary);
        }
        
        body[data-theme="dark"] .card-header {
            background-color: var(--bg-quaternary);
            border-color: var(--border-primary);
            color: var(--text-primary);
        }
        
        body[data-theme="dark"] .card-body {
            color: var(--text-primary);
        }
        
        body[data-theme="dark"] .text-muted {
            color: var(--text-secondary) !important;
        }
        
        body[data-theme="dark"] .modal-content {
            background-color: var(--bg-secondary);
            color: var(--text-primary);
        }
        
        body[data-theme="dark"] .modal-header {
            border-color: var(--border-primary);
        }
        
        body[data-theme="dark"] .modal-footer {
            border-color: var(--border-primary);
        }
        
        body[data-theme="dark"] .form-control,
        body[data-theme="dark"] .form-select {
            background-color: var(--input-bg);
            border-color: var(--border-secondary);
            color: var(--text-primary);
        }
        
        body[data-theme="dark"] .form-control:focus,
        body[data-theme="dark"] .form-select:focus {
            background-color: var(--input-bg);
            border-color: #0071e3;
            color: var(--text-primary);
        }
        
        body[data-theme="dark"] .form-label {
            color: var(--text-primary);
        }
        
        body[data-theme="dark"] .form-check-label {
            color: var(--text-primary);
        }
        
        body[data-theme="dark"] .table {
            color: var(--text-primary);
        }
        
        body[data-theme="dark"] .table thead th {
            background-color: var(--bg-quaternary);
            color: var(--text-primary);
            border-color: var(--border-primary);
        }
        
        body[data-theme="dark"] .table tbody td {
            border-color: var(--border-primary);
        }
        
        body[data-theme="dark"] .table-hover tbody tr:hover {
            background-color: var(--hover-bg);
        }
        
        body[data-theme="dark"] .badge {
            background-color: var(--bg-quaternary);
        }
        
        body[data-theme="dark"] code {
            background-color: var(--bg-quaternary);
            color: var(--text-primary);
        }
        
        body[data-theme="dark"] .btn-close {
            filter: invert(1);
        }
        
        body[data-theme="dark"] .form-check-input {
            background-color: var(--input-bg);
            border-color: var(--border-secondary);
        }
        
        body[data-theme="dark"] .form-check-input:checked {
            background-color: #0071e3;
            border-color: #0071e3;
        }
        
        /* Light mode tabs - ensure visibility */
        .nav-tabs .nav-link {
            color: #495057;
        }
        
        .nav-tabs .nav-link:hover {
            color: #212529;
        }
        
        .nav-tabs .nav-link.active {
            color: #212529;
        }
        
        /* Dark mode tabs */
        body[data-theme="dark"] .nav-tabs {
            border-color: var(--border-primary);
        }
        
        body[data-theme="dark"] .nav-tabs .nav-link {
            color: var(--text-secondary);
            border-color: transparent;
        }
        
        body[data-theme="dark"] .nav-tabs .nav-link:hover {
            color: var(--text-primary);
            border-color: var(--border-primary);
        }
        
        body[data-theme="dark"] .nav-tabs .nav-link.active {
            color: var(--text-primary);
            background-color: var(--bg-secondary);
            border-color: var(--border-primary) var(--border-primary) var(--bg-secondary);
        }
    </style>
</head>
<body>
{% include 'header.html' %}
<div class="container mt-4">
    <h1>Settings</h1>
    <p class="text-muted">Manage corpus entries and application settings</p>
    
    <!-- Tabs Navigation -->
    <ul class="nav nav-tabs mb-4" id="settingsTabs" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="profile-tab" data-bs-toggle="tab" data-bs-target="#profile" type="button" role="tab">
                <i class="fas fa-user"></i> User Profile
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="appearance-tab" data-bs-toggle="tab" data-bs-target="#appearance" type="button" role="tab">
                <i class="fas fa-moon"></i> Appearance
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="models-tab" data-bs-toggle="tab" data-bs-target="#models" type="button" role="tab">
                <i class="fas fa-robot"></i> AI Models
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="corpus-tab" data-bs-toggle="tab" data-bs-target="#corpus" type="button" role="tab">
                <i class="fas fa-database"></i> Corpus Management
            </button>
        </li>
    </ul>
    
    <!-- Tab Content -->
    <div class="tab-content" id="settingsTabContent">
        <!-- User Profile Tab -->
        <div class="tab-pane fade show active" id="profile" role="tabpanel">
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-user"></i> User Profile</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-3 text-center">
                            <div style="width: 150px; height: 150px; margin: 0 auto 1rem auto; position: relative;">
                                <img id="profilePicturePreview" src="" alt="Profile Picture" 
                                     class="rounded-circle" 
                                     style="width: 100%; height: 100%; object-fit: cover; border: 3px solid #0071e3; display: none; position: absolute; top: 0; left: 0; z-index: 2;">
                                <div id="profilePlaceholder" class="rounded-circle d-flex align-items-center justify-content-center" 
                                     style="width: 100%; height: 100%; background: #e9ecef; border: 3px solid #0071e3; position: absolute; top: 0; left: 0; z-index: 1;">
                                    <i class="fas fa-user fa-4x text-muted"></i>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-9">
                            <div class="mb-3">
                                <label for="profileName" class="form-label">Name</label>
                                <input type="text" class="form-control" id="profileName" 
                                       placeholder="e.g., John Doe">
                            </div>
                            
                            <div class="mb-3">
                                <label for="profileUsername" class="form-label">Username</label>
                                <input type="text" class="form-control" id="profileUsername" 
                                       placeholder="e.g., jdoe">
                            </div>
                            
                            <div class="mb-3">
                                <label for="profileEmail" class="form-label">Email</label>
                                <input type="email" class="form-control" id="profileEmail" 
                                       placeholder="e.g., john.doe@example.com">
                            </div>
                            
                            <div class="mb-3">
                                <label for="profilePicture" class="form-label">Profile Picture URL</label>
                                <input type="url" class="form-control" id="profilePicture" 
                                       placeholder="e.g., https://example.com/photo.jpg">
                                <small class="text-muted">Enter a public URL to an image</small>
                            </div>
                            
                            <button class="btn btn-primary" id="saveProfileBtn">
                                <i class="fas fa-save"></i> Save Profile
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Appearance Tab -->
        <div class="tab-pane fade" id="appearance" role="tabpanel">
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-moon"></i> Appearance</h5>
                </div>
                <div class="card-body">
                    <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" id="darkModeToggle">
                        <label class="form-check-label" for="darkModeToggle">
                            <i class="fas fa-moon me-2"></i>Dark Mode
                        </label>
                    </div>
                    <small class="text-muted d-block mt-2">Toggle between light and dark color schemes</small>
                </div>
            </div>
        </div>
        
        <!-- AI Models Tab -->
        <div class="tab-pane fade" id="models" role="tabpanel">
            <!-- Embedding Models Section -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-project-diagram"></i> Embedding Models</h5>
                </div>
                <div class="card-body">
                    <p class="text-muted mb-3">Configure sentence embedding models for semantic analysis (SentenceTransformer compatible)</p>
                    <button class="btn btn-primary mb-3" id="addEmbeddingModelBtn">
                        <i class="fas fa-plus"></i> Add Embedding Model
                    </button>
                    <div id="embeddingModelsList"></div>
                </div>
            </div>
            
            <!-- Large Language Models Section -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-brain"></i> Large Language Models</h5>
                </div>
                <div class="card-body">
                    <p class="text-muted mb-3">Configure LLMs for AI-powered analysis features</p>
                    <button class="btn btn-primary mb-3" id="addLLMBtn">
                        <i class="fas fa-plus"></i> Add LLM
                    </button>
                    <div id="llmList"></div>
                </div>
            </div>
        </div>
        
        <!-- Corpus Management Tab -->
        <div class="tab-pane fade" id="corpus" role="tabpanel">
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-database"></i> Corpus Management</h5>
                </div>
                <div class="card-body">
                    <button class="btn btn-primary mb-3" id="addCorpusBtn">
                        <i class="fas fa-plus"></i> Add New Corpus
                    </button>
                    
                    <div id="corporaList"></div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Add/Edit Corpus Modal -->
    <div class="modal fade" id="corpusModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="corpusModalTitle">Add Corpus</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="corpusForm">
                        <input type="hidden" id="corpusIndex" value="">
                        
                        <div class="mb-3">
                            <label for="fullName" class="form-label">Full Name</label>
                            <input type="text" class="form-control" id="fullName" 
                                   placeholder="e.g., Corpus of Contemporary American English" required>
                        </div>
                        
                        <div class="mb-3">
                            <label for="friendlyName" class="form-label">Friendly Name</label>
                            <input type="text" class="form-control" id="friendlyName" 
                                   placeholder="e.g., COCA" required>
                        </div>
                        
                        <div class="mb-3">
                            <label for="relativeFilepath" class="form-label">Relative Filepath</label>
                            <input type="text" class="form-control" id="relativeFilepath" 
                                   placeholder="e.g., data/english-corpora.org/coca" required>
                            <small class="text-muted">Path relative to project root</small>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="saveCorpusBtn">Save</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Add/Edit Embedding Model Modal -->
    <div class="modal fade" id="embeddingModelModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="embeddingModelModalTitle">Add Embedding Model</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="embeddingModelForm">
                        <input type="hidden" id="embeddingModelIndex" value="">
                        
                        <div class="mb-3">
                            <label for="embeddingModelName" class="form-label">Display Name</label>
                            <input type="text" class="form-control" id="embeddingModelName" 
                                   placeholder="e.g., EmbeddingGemma 300M" required>
                        </div>
                        
                        <div class="mb-3">
                            <label for="embeddingModelId" class="form-label">Model ID (Hugging Face)</label>
                            <input type="text" class="form-control" id="embeddingModelId" 
                                   placeholder="e.g., google/embeddinggemma-300m" required>
                            <small class="text-muted">SentenceTransformer compatible model from Hugging Face</small>
                        </div>
                        
                        <div class="mb-3">
                            <label for="embeddingModelType" class="form-label">Model Type</label>
                            <select class="form-select" id="embeddingModelType">
                                <option value="semantic">Semantic Similarity</option>
                                <option value="classification">Classification</option>
                                <option value="sarcasm">Sarcasm Detection</option>
                            </select>
                        </div>
                        
                        <div class="mb-3">
                            <label for="embeddingModelDescription" class="form-label">Description</label>
                            <textarea class="form-control" id="embeddingModelDescription" rows="2"
                                      placeholder="Brief description of the model's purpose"></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="saveEmbeddingModelBtn">Save</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Add/Edit LLM Modal -->
    <div class="modal fade" id="llmModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="llmModalTitle">Add LLM</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="llmForm">
                        <input type="hidden" id="llmIndex" value="">
                        
                        <div class="mb-3">
                            <label for="llmName" class="form-label">Display Name</label>
                            <input type="text" class="form-control" id="llmName" 
                                   placeholder="e.g., Claude 3.5 Sonnet" required>
                        </div>
                        
                        <div class="mb-3">
                            <label for="llmModelId" class="form-label">Model ID</label>
                            <input type="text" class="form-control" id="llmModelId" 
                                   placeholder="e.g., anthropic.claude-3-5-sonnet-20241022-v2:0" required>
                        </div>
                        
                        <div class="mb-3">
                            <label for="llmProvider" class="form-label">Provider</label>
                            <select class="form-select" id="llmProvider">
                                <option value="bedrock_converse">AWS Bedrock</option>
                                <option value="openai">OpenAI</option>
                                <option value="anthropic">Anthropic</option>
                                <option value="huggingface">Hugging Face</option>
                            </select>
                        </div>
                        
                        <div class="mb-3">
                            <label for="llmDescription" class="form-label">Description</label>
                            <textarea class="form-control" id="llmDescription" rows="2"
                                      placeholder="Brief description of the model"></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="saveLLMBtn">Save</button>
                </div>
            </div>
        </div>
    </div>
</div>
{% include 'footer.html' %}
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    let currentSettings = null;
    let corpusModal = null;

    // Initialize modal and dark mode
    document.addEventListener('DOMContentLoaded', function() {
        corpusModal = new bootstrap.Modal(document.getElementById('corpusModal'));
        loadSettings();
        loadProfile();
        initializeDarkMode();
        
        // Listen for profile picture URL changes
        document.getElementById('profilePicture').addEventListener('input', function() {
            updateProfilePicture(this.value);
        });
    });

    // User Profile Functions
    function loadProfile() {
        const profile = {
            name: localStorage.getItem('profile_name') || '',
            username: localStorage.getItem('profile_username') || '',
            email: localStorage.getItem('profile_email') || '',
            picture: localStorage.getItem('profile_picture') || ''
        };
        
        document.getElementById('profileName').value = profile.name;
        document.getElementById('profileUsername').value = profile.username;
        document.getElementById('profileEmail').value = profile.email;
        document.getElementById('profilePicture').value = profile.picture;
        
        updateProfilePicture(profile.picture);
    }
    
    function updateProfilePicture(url) {
        const preview = document.getElementById('profilePicturePreview');
        const placeholder = document.getElementById('profilePlaceholder');
        
        if (url && url.trim() !== '') {
            // Test if image loads successfully
            const testImg = new Image();
            testImg.onload = function() {
                preview.src = url;
                preview.style.display = 'block';
                placeholder.style.display = 'none';
            };
            testImg.onerror = function() {
                // Image failed to load, show placeholder
                preview.style.display = 'none';
                placeholder.style.display = 'flex';
            };
            testImg.src = url;
        } else {
            preview.style.display = 'none';
            placeholder.style.display = 'flex';
        }
    }
    
    // Save profile
    document.getElementById('saveProfileBtn').addEventListener('click', function() {
        const profile = {
            name: document.getElementById('profileName').value,
            username: document.getElementById('profileUsername').value,
            email: document.getElementById('profileEmail').value,
            picture: document.getElementById('profilePicture').value
        };
        
        // Save to localStorage (will move to database later)
        localStorage.setItem('profile_name', profile.name);
        localStorage.setItem('profile_username', profile.username);
        localStorage.setItem('profile_email', profile.email);
        localStorage.setItem('profile_picture', profile.picture);
        
        // Also save to settings.json for persistence
        if (currentSettings) {
            currentSettings.user_profile = profile;
            saveSettingsToServer();
        }
        
        alert('Profile saved successfully!');
    });
    
    async function saveSettingsToServer() {
        try {
            const response = await fetch('/api/settings', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(currentSettings)
            });
            
            const data = await response.json();
            if (!data.success) {
                console.error('Failed to save settings to server:', data.error);
            }
        } catch (error) {
            console.error('Network error saving settings:', error);
        }
    }
    
    // Dark Mode Functions
    function initializeDarkMode() {
        const darkModeToggle = document.getElementById('darkModeToggle');
        const isDarkMode = localStorage.getItem('darkMode') === 'true';
        
        // Set initial state
        darkModeToggle.checked = isDarkMode;
        if (isDarkMode) {
            document.body.setAttribute('data-theme', 'dark');
        }
        
        // Listen for changes
        darkModeToggle.addEventListener('change', function() {
            if (this.checked) {
                document.body.setAttribute('data-theme', 'dark');
                localStorage.setItem('darkMode', 'true');
            } else {
                document.body.removeAttribute('data-theme');
                localStorage.setItem('darkMode', 'false');
            }
        });
    }

    // Load settings
    async function loadSettings() {
        try {
            const response = await fetch('/api/settings');
            const data = await response.json();
            
            if (data.success) {
                currentSettings = data.settings;
                
                // Load user profile from settings if available
                if (currentSettings.user_profile) {
                    localStorage.setItem('profile_name', currentSettings.user_profile.name || '');
                    localStorage.setItem('profile_username', currentSettings.user_profile.username || '');
                    localStorage.setItem('profile_email', currentSettings.user_profile.email || '');
                    localStorage.setItem('profile_picture', currentSettings.user_profile.picture || '');
                    loadProfile();
                }
                
                renderCorpora();
                initializeDefaultModels();
            } else {
                alert('Error loading settings: ' + (data.error || 'Unknown error'));
            }
        } catch (error) {
            alert('Network error: ' + error.message);
        }
    }

    // Render corpora list
    function renderCorpora() {
        const container = document.getElementById('corporaList');
        
        if (!currentSettings.corpora || currentSettings.corpora.length === 0) {
            container.innerHTML = '<p class="text-muted">No corpora configured. Add one to get started.</p>';
            return;
        }
        
        let html = '<div class="table-responsive"><table class="table table-hover">';
        html += '<thead><tr><th>Full Name</th><th>Friendly Name</th><th>Filepath</th><th>Actions</th></tr></thead><tbody>';
        
        currentSettings.corpora.forEach((corpus, index) => {
            html += `
                <tr>
                    <td>${corpus.full_name}</td>
                    <td><span class="badge bg-primary">${corpus.friendly_name}</span></td>
                    <td><code>${corpus.relative_filepath}</code></td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary" onclick="editCorpus(${index})">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-danger" onclick="deleteCorpus(${index})">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                </tr>
            `;
        });
        
        html += '</tbody></table></div>';
        container.innerHTML = html;
    }

    // Add corpus button
    document.getElementById('addCorpusBtn').addEventListener('click', function() {
        document.getElementById('corpusModalTitle').textContent = 'Add Corpus';
        document.getElementById('corpusIndex').value = '';
        document.getElementById('corpusForm').reset();
        corpusModal.show();
    });

    // Edit corpus
    function editCorpus(index) {
        const corpus = currentSettings.corpora[index];
        document.getElementById('corpusModalTitle').textContent = 'Edit Corpus';
        document.getElementById('corpusIndex').value = index;
        document.getElementById('fullName').value = corpus.full_name;
        document.getElementById('friendlyName').value = corpus.friendly_name;
        document.getElementById('relativeFilepath').value = corpus.relative_filepath;
        corpusModal.show();
    }

    // Delete corpus
    async function deleteCorpus(index) {
        if (!confirm('Are you sure you want to delete this corpus entry?')) {
            return;
        }
        
        try {
            const response = await fetch(`/api/corpus/${index}`, {
                method: 'DELETE'
            });
            
            const data = await response.json();
            
            if (data.success) {
                await loadSettings();
            } else {
                alert('Error: ' + (data.error || 'Unknown error'));
            }
        } catch (error) {
            alert('Network error: ' + error.message);
        }
    }

    // Save corpus
    document.getElementById('saveCorpusBtn').addEventListener('click', async function() {
        const index = document.getElementById('corpusIndex').value;
        const corpusData = {
            full_name: document.getElementById('fullName').value,
            friendly_name: document.getElementById('friendlyName').value,
            relative_filepath: document.getElementById('relativeFilepath').value
        };
        
        // Validate
        if (!corpusData.full_name || !corpusData.friendly_name || !corpusData.relative_filepath) {
            alert('Please fill in all fields');
            return;
        }
        
        try {
            let response;
            
            if (index === '') {
                // Add new
                response = await fetch('/api/corpus', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(corpusData)
                });
            } else {
                // Update existing
                response = await fetch(`/api/corpus/${index}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(corpusData)
                });
            }
            
            const data = await response.json();
            
            if (data.success) {
                corpusModal.hide();
                await loadSettings();
            } else {
                alert('Error: ' + (data.error || 'Unknown error'));
            }
        } catch (error) {
            alert('Network error: ' + error.message);
        }
    });
    
    // ============================================
    // AI Models Management
    // ============================================
    
    let embeddingModelModal = null;
    let llmModal = null;
    
    document.addEventListener('DOMContentLoaded', function() {
        embeddingModelModal = new bootstrap.Modal(document.getElementById('embeddingModelModal'));
        llmModal = new bootstrap.Modal(document.getElementById('llmModal'));
        
        // Initialize default models if not set
        initializeDefaultModels();
    });
    
    function initializeDefaultModels() {
        if (!currentSettings) return;
        
        // Default embedding models
        if (!currentSettings.embedding_models) {
            currentSettings.embedding_models = [
                {
                    name: 'EmbeddingGemma 300M',
                    model_id: 'google/embeddinggemma-300m',
                    type: 'semantic',
                    description: 'Google embedding model for semantic similarity'
                },
                {
                    name: 'Sarcasm Detector',
                    model_id: 'helinivan/english-sarcasm-detector',
                    type: 'sarcasm',
                    description: 'Detects sarcasm in English text'
                }
            ];
        }
        
        // Default LLMs
        if (!currentSettings.llms) {
            currentSettings.llms = [
                {
                    name: 'Claude 3.5 Sonnet',
                    model_id: 'anthropic.claude-3-5-sonnet-20241022-v2:0',
                    provider: 'bedrock_converse',
                    description: 'Anthropic Claude via AWS Bedrock'
                }
            ];
        }
        
        renderEmbeddingModels();
        renderLLMs();
    }
    
    // Render embedding models
    function renderEmbeddingModels() {
        const container = document.getElementById('embeddingModelsList');
        
        if (!currentSettings.embedding_models || currentSettings.embedding_models.length === 0) {
            container.innerHTML = '<p class="text-muted">No embedding models configured.</p>';
            return;
        }
        
        let html = '<div class="table-responsive"><table class="table table-hover">';
        html += '<thead><tr><th>Name</th><th>Model ID</th><th>Type</th><th>Actions</th></tr></thead><tbody>';
        
        currentSettings.embedding_models.forEach((model, index) => {
            const typeBadge = {
                'semantic': 'bg-primary',
                'classification': 'bg-success',
                'sarcasm': 'bg-warning'
            }[model.type] || 'bg-secondary';
            
            html += `
                <tr>
                    <td>${model.name}</td>
                    <td><code>${model.model_id}</code></td>
                    <td><span class="badge ${typeBadge}">${model.type}</span></td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary" onclick="editEmbeddingModel(${index})">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-danger" onclick="deleteEmbeddingModel(${index})">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                </tr>
            `;
        });
        
        html += '</tbody></table></div>';
        container.innerHTML = html;
    }
    
    // Render LLMs
    function renderLLMs() {
        const container = document.getElementById('llmList');
        
        if (!currentSettings.llms || currentSettings.llms.length === 0) {
            container.innerHTML = '<p class="text-muted">No LLMs configured.</p>';
            return;
        }
        
        let html = '<div class="table-responsive"><table class="table table-hover">';
        html += '<thead><tr><th>Name</th><th>Model ID</th><th>Provider</th><th>Actions</th></tr></thead><tbody>';
        
        currentSettings.llms.forEach((model, index) => {
            html += `
                <tr>
                    <td>${model.name}</td>
                    <td><code>${model.model_id}</code></td>
                    <td><span class="badge bg-info">${model.provider}</span></td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary" onclick="editLLM(${index})">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-danger" onclick="deleteLLM(${index})">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                </tr>
            `;
        });
        
        html += '</tbody></table></div>';
        container.innerHTML = html;
    }
    
    // Add embedding model button
    document.getElementById('addEmbeddingModelBtn').addEventListener('click', function() {
        document.getElementById('embeddingModelModalTitle').textContent = 'Add Embedding Model';
        document.getElementById('embeddingModelIndex').value = '';
        document.getElementById('embeddingModelForm').reset();
        embeddingModelModal.show();
    });
    
    // Edit embedding model
    function editEmbeddingModel(index) {
        const model = currentSettings.embedding_models[index];
        document.getElementById('embeddingModelModalTitle').textContent = 'Edit Embedding Model';
        document.getElementById('embeddingModelIndex').value = index;
        document.getElementById('embeddingModelName').value = model.name;
        document.getElementById('embeddingModelId').value = model.model_id;
        document.getElementById('embeddingModelType').value = model.type;
        document.getElementById('embeddingModelDescription').value = model.description || '';
        embeddingModelModal.show();
    }
    
    // Delete embedding model
    async function deleteEmbeddingModel(index) {
        if (!confirm('Are you sure you want to delete this embedding model?')) {
            return;
        }
        
        currentSettings.embedding_models.splice(index, 1);
        await saveSettingsToServer();
        renderEmbeddingModels();
    }
    
    // Save embedding model
    document.getElementById('saveEmbeddingModelBtn').addEventListener('click', async function() {
        const index = document.getElementById('embeddingModelIndex').value;
        const modelData = {
            name: document.getElementById('embeddingModelName').value,
            model_id: document.getElementById('embeddingModelId').value,
            type: document.getElementById('embeddingModelType').value,
            description: document.getElementById('embeddingModelDescription').value
        };
        
        if (!modelData.name || !modelData.model_id) {
            alert('Please fill in required fields');
            return;
        }
        
        if (!currentSettings.embedding_models) {
            currentSettings.embedding_models = [];
        }
        
        if (index === '') {
            currentSettings.embedding_models.push(modelData);
        } else {
            currentSettings.embedding_models[parseInt(index)] = modelData;
        }
        
        await saveSettingsToServer();
        embeddingModelModal.hide();
        renderEmbeddingModels();
    });
    
    // Add LLM button
    document.getElementById('addLLMBtn').addEventListener('click', function() {
        document.getElementById('llmModalTitle').textContent = 'Add LLM';
        document.getElementById('llmIndex').value = '';
        document.getElementById('llmForm').reset();
        llmModal.show();
    });
    
    // Edit LLM
    function editLLM(index) {
        const model = currentSettings.llms[index];
        document.getElementById('llmModalTitle').textContent = 'Edit LLM';
        document.getElementById('llmIndex').value = index;
        document.getElementById('llmName').value = model.name;
        document.getElementById('llmModelId').value = model.model_id;
        document.getElementById('llmProvider').value = model.provider;
        document.getElementById('llmDescription').value = model.description || '';
        llmModal.show();
    }
    
    // Delete LLM
    async function deleteLLM(index) {
        if (!confirm('Are you sure you want to delete this LLM?')) {
            return;
        }
        
        currentSettings.llms.splice(index, 1);
        await saveSettingsToServer();
        renderLLMs();
    }
    
    // Save LLM
    document.getElementById('saveLLMBtn').addEventListener('click', async function() {
        const index = document.getElementById('llmIndex').value;
        const modelData = {
            name: document.getElementById('llmName').value,
            model_id: document.getElementById('llmModelId').value,
            provider: document.getElementById('llmProvider').value,
            description: document.getElementById('llmDescription').value
        };
        
        if (!modelData.name || !modelData.model_id) {
            alert('Please fill in required fields');
            return;
        }
        
        if (!currentSettings.llms) {
            currentSettings.llms = [];
        }
        
        if (index === '') {
            currentSettings.llms.push(modelData);
        } else {
            currentSettings.llms[parseInt(index)] = modelData;
        }
        
        await saveSettingsToServer();
        llmModal.hide();
        renderLLMs();
    });
</script>
</body>
</html>
